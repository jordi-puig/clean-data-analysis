---
title: 'Tipologia i cicle de vida de les dades: PRA2 - Neteja i anàlisi de les dades'
author: "Autor: Jordi Puig OVejero"
date: "Desembre 2020"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: header.html
  pdf_document:
    highlight: zenburn
    toc: yes
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval=T, echo=T)
```

Carrega de les llibreries que es necessiten
```{r message= FALSE, warning=FALSE}
library(ggpubr)
library(ggplot2)
library(arules)
library(dplyr)
library(factoextra)
library(FactoMineR)
```

******
# Descripció del dataset. Perquè és important i quina pregunta/problema pretén respondre?
******

Per a realitzar un estudi amb l'algoritme de classificació he agafat un dataset de [marqueting bancari](https://archive.ics.uci.edu/ml/datasets/Bank+Marketing).

Les dades estan relacionades amb campanyes de màrqueting directe d’una institució bancària portuguesa. Aquestes campanyes, basades en trucades de telèfon, buscaven clients que contractessin un dipòsit a termini. Sovint, es requeria més d’una trucada amb el mateix client per a concretar la transacció.

Aquest dataset permet respondre a la pregunta per predir si un client subscriurà ("yes"/"no") un dipòsit a termini a partir d'una sèrie de dades del client (age, job, marital, education...). Si tenim una bona segmentació dels clients i fem una bona predicció el banc pot fer campanyes molt dirigides a obtenir resultats positius.

Durant l'exercici direm que un usuari ha convertit, és a dir, tenim una conversió, si y = 'yes'. En cas contrari, direm que no ha convertit. El concepte **conversió** sortirà durant tot l'exercici.


El fitxer on es troba el data set és, **bank-full.csv**:

* Nombre d'instancies: 45211
* Nombre d'instancies: 16 + atribut de sortida (total 17)


## Definició dels atributs

**Dades del client:**

* 1 - age (numeric)
* 2 - job : tipus de feina (categorical): 'admin.','unknown','unemployed','management','housemaid','entrepreneur','student','blue-collar','self-employed','retired','technician','services')
* 3 - marital : estat civil (categorical: 'divorced','married','single'; note: 'divorced' means divorced or widowed)
* 4 - education (categorical: 'primary','seconday','tertiary','unknown')
* 5 - default: té crèdit per defecte? (categorical: 'no','yes')
* 6 - balance: mitja de saldo anual, en euros (numeric) 
* 7 - housing: té préstec d'habitatge? (categorical: 'no','yes')
* 8 - loan: té préstec personal? (categorical: 'no','yes')

**Atributs relacionats amb el darrer contacte de la campanya actual:**

* 9 - contact: com ha estat la comunicació (categorical: 'cellular','telephone','unknown')
* 10 - month: darrer contacte, mes de l'any (categorical: 'jan', 'feb', 'mar', ..., 'nov', 'dec')
* 11 - day: darrer contacte, dia del més (numeric)
* 12 - duration: darrer contacte, en segons (numeric).

**Altres atributs:**

* 13 - campaign: nombre de contactes realitzats durant aquesta campanya i per a aquest client (numeric, inclou el darrer contacte)
* 14 - pdays: nombre de dies que han passat des de el darrer contacte d'una campanya anterior (numeric; -1 significa que no ha estat contactat previament)
* 15 - previous: nombre de contactes realitzats abans d'aquesta campanya i per a aquest client (numeric)
* 16 - poutcome: resultat de la campanya de màrqueting anterior (categorical: 'unknown','other','failure','success')

#### Variable de sortida (objectiu desitjat, ens indica si el registre ha convertit o no)

* 17 - y - El client ha subscrit el dipòsit a termini? (binary: 'yes','no')

******
# Integració i selecció de les dades d’interès a analitzar.
******
Carreguem les dades i fem un summary general (després el farem per parts). Els elements categòrics estan carregats com a *factor* des d'un inici. Per les variables categòriques prefereixo treballar com a factor que com character. Ens facilita les coses per ordenació o per veure les diferents categories que hi ha.

```{r message= FALSE, warning=FALSE}
bank <- read.csv('bank-full.csv',stringsAsFactors = TRUE, sep = ';')
attach(bank) # ens permet referenciar les columnes de bank sense haver de especificar el dataset.
summary(bank)
```

Amb aquesta informació podem dir que: 

* La mitja d'edat està quasi en els 41 anys i el 3Q en els 48. Per tant intueixo que gran part de la mostra està en una franja d'edat relativament jove.
* Tenim valors 'unknown' a education però no sembla molt significatiu el nombre.
* A balance veiem possibles valors atípics (outliers).
* Tenim molts valors unkwown en el registre contact. Així que segurament no els esborrarem i farem servir com una categoria més o els haurem d'inferir.
* Al mes de maig és on tenim més mostra
* La mitja de la duració de la trucada és d'uns 3 minuts. 1Q = 1.6 minuts aprox. i 3Q = 5.3. Tenim alguns valors atípics amb una trucada de 82 minuts.
* campaign: sembla tenir outliers ja que el 3Q està a 3 i tenim un 63.
* previous: el mateix passar amb previous
* poutcome: té molts valors unknown que no esborrare per no reduïr tant la mostra i ens serviran com a altre categoria

*****
# Neteja de les dades.
*****

## Les dades contenen zeros o elements buits? Com gestionaries aquests casos?

```{r message= FALSE, warning=FALSE}
colSums(is.na(bank))
```

No tenim valors nulls però hi ha 'unknown', com hem vist en l'anàlisi exploratori, en alguns atributs categòrics que ara tractarem.

Tenim 3 opcions per aquests valors:

1. Eliminar els registres
2. Assignar per un valor estimat
3. No fer res i tractar-los com a una categoria.

Optarem per la solució 3 segons la proporció d'elements de la mostra ja que: 

* Els valors 'unknown' poden representar per si mateix una categoria única.
* Pot haver-hi una diferència important de dades si eliminem els 'unknown'
* Tot el que ha causat el camp 'unknown' pot estar relacionat amb el resultat.

De totes maneres anem a estudiar aquests elements:

Anem a comprovar els percentatges de unknown
```{r message= FALSE, warning=FALSE}
# valors 'unknown' de job
{
print("Job")
print(prop.table(table(bank$job)), 2)
}

# valors 'unknown' de education
{
cat('\n')
print('Education:')
print(prop.table(table(bank$education)), 2)
}

# valors 'unknown' de contact
{
cat('\n')
print('Contact:')
print(prop.table(table(bank$contact)), 2)
}

# valors 'unknown' de poutcome
{
cat('\n')  
print('Poutcome:')
print(prop.table(table(bank$poutcome)), 2)
}
```

Com podem observar podem eliminar els 'unknown' de job i education perquè la proporció és petita, en canvi, amb contact i poutcome podríem fer una assignació estimada o deixar-los com a categoria pròpia, ja que tenim quasi un 30% en contact i més d'un 80% en poutcome.

Per tant, eliminem els de education i job i deixem els de contact i poutcome.

```{r message= FALSE, warning=FALSE}
# eliminem els unknown de job i de education
total.rows <- nrow(bank);
bank.clean <-subset(bank, education != "unknown")
bank.clean <- subset(bank.clean, job != "unknown")

# eliminem categories buides
bank.clean <- droplevels(bank.clean)

rows <- nrow(bank.clean);
(rows / total.rows) * 100
```

Eliminant els unknown de education i job encara tindríem més del 95.5% de la mostra. 

## Identificació i tractament de valors extrems. (outliers)

Ara anem a veure els valors atípics. Per a trobar valors extrems anem a aplicar la idea dels IQR (interquartile ranges):
* [referència1:](http://www.mathwords.com/o/outlier.htm)
* [referència2:](http://r-statistics.co/Outlier-Treatment-With-R.html)

Per a una determinada variable contínua, els outliers són aquelles observacions que es troben fora de 1.5 * IQR, on IQR, el "Inter Quartile Range" és la diferència entre el Q3 i el Q1:


* Interquartile range, IQR = Q3 - Q1
* lower = Q1 - 1.5 * IQR 
* Upper = Q3 + 1.5 * IQR

### Funció per treure els límits dels valors atípics
```{r message= FALSE, warning=FALSE}
outliersLimits <- function(x) {
    limits <- c("above", "under")
    limits$above <- quantile(x, 0.75, type=6) + 1.5 * (quantile(x, 0.75, type=6) - quantile(x, 0.25, type=6))
    limits$under <- quantile(x, 0.25, type=6) - 1.5 * (quantile(x, 0.75, type=6) - quantile(x, 0.25, type=6))
  return(limits)
}
```

### Valors atípics a age
```{r message= FALSE, warning=FALSE}
ggplot(data = bank.clean ,aes(x=y,y=age))+geom_boxplot()

# podem veure els límits de age
limits <- outliersLimits(bank.clean$age)
paste("Límit inferior:", limits$under)
paste("Límit superior:", limits$above)

# treiem aquest valors atípics
bank.clean <-subset(bank.clean, age >= limits$under)
bank.clean <-subset(bank.clean, age <= limits$above)

ggplot(data = bank.clean,aes(x=y,y=age))+geom_boxplot()

total.rows <- nrow(bank.clean);
rows <- nrow(bank.clean)
(rows / total.rows) * 100
```

Amb boxplot podem preveure alguns valors d'edat que tenen molt poca mostra i no ens donarien molta informació.


### El mateix per a balance
```{r message= FALSE, warning=FALSE}
ggplot(data = bank.clean ,aes(x=y,y=balance))+geom_boxplot()

total.rows <- nrow(bank.clean);

# podem veure els límits de balance
limits <- outliersLimits(bank.clean$balance)
paste("Límit inferior:", limits$under)
paste("Límit superior:", limits$above)

# treiem aquest valors atípics
bank.clean <-subset(bank.clean, balance >= limits$under)
bank.clean <-subset(bank.clean, balance <= limits$above)

ggplot(data = bank.clean,aes(x=y,y=balance))+geom_boxplot()

rows <- nrow(bank.clean)
(rows / total.rows) * 100
```

Les mostres queden molt més compactades eliminant aquests valors extrems.

```{r message= FALSE, warning=FALSE}
total.rows <- nrow(bank);
rows <- nrow(bank.clean);
(rows / total.rows) * 100
```

Finalment hem calculat el quin percentatge de la mostra hem eliminat amb els valors atípics i el 'unkwown' i ens ha quedat un 84.61% del total.

Treballarem el model bank.clean on hem tret alguns unknown i valors atípics.

## Exportació de dades netejades
Un cop hem netejat les dades les anem a emmagatzemar físicament en un arxiu csv.
```{r message= FALSE, warning=FALSE}
write.csv(bank.clean, "bank_clean.csv")
```

******
# Anàlisi de les dades.
******

## Selecció dels grups de dades que es volen analitzar/comparar (planificació dels anàlisis a aplicar)

## Comprovació de la normalitat i homogeneïtat de la variància.

## Aplicació de proves estadístiques per comparar els grups de dades. En funció de les dades i de l’objectiu de l’estudi, aplicar proves de contrast d’hipòtesis, correlacions, regressions, etc. Aplicar almenys tres mètodes d’anàlisi diferents.


******
# Representació dels resultats a partir de taules i gràfiques.
******

******
# Resolució del problema. A partir dels resultats obtinguts, quines són les conclusions? Els resultats permeten respondre al problema?
******


